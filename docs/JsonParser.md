# JSON Tokenizer & Parser ‚Äî –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è

## TL;DR

* **Tokenizer**: –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—î –≤—Ö—ñ–¥–Ω–∏–π JSON-—Ç–µ–∫—Å—Ç –Ω–∞ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å —Ç–æ–∫–µ–Ω—ñ–≤ (`TokenType` + –∑–Ω–∞—á–µ–Ω–Ω—è).
* **Parser**: —á–∏—Ç–∞—î —Ç–æ–∫–µ–Ω–∏ –∫—É—Ä—Å–æ—Ä–æ–º —ñ –±—É–¥—É—î –∑–Ω–∞—á–µ–Ω–Ω—è JSON (object/array/primitive) –∞–±–æ –æ–¥—Ä–∞–∑—É **–±—ñ–Ω–¥–∏—Ç—å** —É POJO —á–µ—Ä–µ–∑ Reflection (Binder).

---

## –¶—ñ–ª—ñ —Ç–∞ –º–µ–∂—ñ

### –¶—ñ–ª—ñ

* –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π, —à–≤–∏–¥–∫–∏–π, –∑—Ä–æ–∑—É–º—ñ–ª–∏–π **—Å—Ç—Ä—ñ–º—ñ–Ω–≥–æ–≤–∏–π** —Ç–æ–∫–µ–Ω–∞–π–∑–µ—Ä (–±–µ–∑ –∑–∞–π–≤–∏—Ö –∞–ª–æ–∫–∞—Ü—ñ–π).
* –ü–∞—Ä—Å–µ—Ä –∑ **—Ä–µ–∫—É—Ä—Å–∏–≤–Ω–∏–º —Å–ø—É—Å–∫–æ–º**.

### –û–±–º–µ–∂–µ–Ω–Ω—è (–ø–æ—Ç–æ—á–Ω—ñ)

* –ü—ñ–¥—Ç—Ä–∏–º—É—é—Ç—å—Å—è: `string` (–∑ escape + `\uXXXX`), `number` (int/frac/exp), `true/false/null`, –æ–±‚Äô—î–∫—Ç–∏ `{}`, –º–∞—Å–∏–≤–∏ `[]`.
* –Æ–Ω—ñ–∫–æ–¥ –ø–æ–∑–∞ BMP –∑–≤–æ–¥–∏—Ç—å—Å—è –¥–æ —Å—É—Ä–æ–≥–∞—Ç–Ω–∏—Ö –ø–∞—Ä —è–∫ –¥–≤–∞ `char` (–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –¥–ª—è Java `String`).
* –ë–µ–∑ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤, –±–µ–∑ —Å–ø–µ—Ü–∏—Ñ—ñ–∫–∏ JSON5.

---

### –ü—ñ–¥—Ç—Ä–∏–º—É–≤–∞–Ω—ñ —Ç–æ–∫–µ–Ω–∏ (`TokenType`)

* –°—Ç—Ä—É–∫—Ç—É—Ä–Ω—ñ: `START_OBJECT {`, `END_OBJECT }`, `START_ARRAY [`, `END_ARRAY ]`, `COLON :`, `COMMA ,`
* –ó–Ω–∞—á–µ–Ω–Ω—è: `FIELD_NAME`, `STRING_VALUE`, `NUMBER_VALUE`, `TRUE_VALUE`, `FALSE_VALUE`, `NULL_VALUE`
* –°–ª—É–∂–±–æ–≤–∏–π: `EOF`

### –ê–ª–≥–æ—Ä–∏—Ç–º (—Å–ø—Ä–æ—â–µ–Ω–æ)

1. **skipWhitespace**: –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ –ø—Ä–æ–±—ñ–ª–∏/—Ç–∞–±/–Ω–æ–≤—ñ —Ä—è–¥–∫–∏.
2. –ß–∏—Ç–∞—î–º–æ —Å–∏–º–≤–æ–ª:

    * `{`/`}`/`[`/`]`/`:`/`,` ‚Üí –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π —Ç–æ–∫–µ–Ω.
    * `"` ‚Üí `parseString`: —á–∏—Ç–∞—î–º–æ —Ä—è–¥–æ–∫; —è–∫—â–æ –ø—ñ—Å–ª—è –ª–∞–ø–∫–∏ (`"`) —Å—Ç–æ—ó—Ç—å `:` (—á–µ—Ä–µ–∑ whitespace) ‚Äî —Ü–µ `FIELD_NAME`, —ñ–Ω–∞–∫—à–µ `STRING_VALUE`. –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ escape + `\uXXXX`.
    * `-` –∞–±–æ —Ü–∏—Ñ—Ä–∞ ‚Üí `parseNumber`: –∑–Ω–∞–∫, —Ü—ñ–ª–∞ —á–∞—Å—Ç–∏–Ω–∞ (`0` –∞–±–æ `1..9` + —Ü–∏—Ñ—Ä–∏), –¥—Ä–æ–±–æ–≤–∞ (`.digits`), –µ–∫—Å–ø–æ–Ω–µ–Ω—Ç–∞ (`e|E[+/-]?digits`), –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ **boundary**.
    * `true|false|null` + **boundary** ‚Üí –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π —Ç–æ–∫–µ–Ω.
    * –Ü–Ω–∞–∫—à–µ ‚Äî –ø–æ–º–∏–ª–∫–∞ `Unexpected char`.

### –ö–ª—é—á–æ–≤—ñ –º–µ—Ç–æ–¥–∏ (–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∏)

* `parseString(char[] chars, int quotePos) -> Parsed<Token>`
  –ü–æ–≤–µ—Ä—Ç–∞—î —Ç–æ–∫–µ–Ω —Ç–∞ `nextPos` (–ø–æ–∑–∏—Ü—ñ—è **–ø—ñ—Å–ª—è** –∑–∞–∫—Ä–∏–≤–∞–ª—å–Ω–æ—ó `"`)
  –û–±—Ä–æ–±–ª—è—î `\" \\ \/ \b \f \n \r \t \uXXXX`.
* `parseNumber(char[] chars, int start) -> Parsed<Token>`
  –í–∞–ª—ñ–¥–Ω–∏–π JSON-—Ñ–æ—Ä–º–∞—Ç —á–∏—Å–ª–∞; boundary: –Ω–∞—Å—Ç—É–ø–Ω–∏–π —Å–∏–º–≤–æ–ª ‚àà { whitespace, ',', ']', '}', EOF }.
* `isLiteralBoundary(char[] chars, int pos)`
  –ö–∏–¥–∞—î –ø–æ–º–∏–ª–∫—É, —è–∫—â–æ boundary –Ω–µ –≤–∞–ª—ñ–¥–Ω–∏–π –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –∑–Ω–∞—á–µ–Ω–Ω—è.
* `startsWith(chars, pos, "true")` –∑ –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é –¥–æ–≤–∂–∏–Ω–∏.

### –ê–ª–≥–æ—Ä–∏—Ç–º

* `parse()`:
    * —è–∫—â–æ `START_OBJECT` ‚Üí `parseObject()`
    * —è–∫—â–æ `START_ARRAY` ‚Üí `parseArray()`
    * —è–∫—â–æ `STRING/NUMBER/TRUE/FALSE/NULL` ‚Üí `parsePrimitive()`

* `parseObject()`:
    * `START_OBJECT`
    * –ø–æ–∫–∏ –Ω–µ `END_OBJECT`: `FIELD_NAME`, `COLON`, `parse()` –¥–ª—è –∑–Ω–∞—á–µ–Ω–Ω—è; –æ–ø—Ü—ñ–π–Ω–æ `COMMA`
    * `END_OBJECT`

* `parseArray()`:
    * `START_ARRAY`
    * –ø–æ–∫–∏ –Ω–µ `END_ARRAY`: `parse()`; –æ–ø—Ü—ñ–π–Ω–æ `COMMA`
    * `END_ARRAY`

### –ü–æ–≤–µ–¥—ñ–Ω–∫–∞

* –í—Ö–æ–¥–∏—Ç—å —É `START_OBJECT`, —Å—Ç–≤–æ—Ä—é—î —ñ–Ω—Å—Ç–∞–Ω—Å `T` (no-arg ctor).
* –î–ª—è –∫–æ–∂–Ω–æ–≥–æ `FIELD_NAME` —à—É–∫–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π `Field` —É `T`.
* –í–∏–∑–Ω–∞—á–∞—î `Type` –ø–æ–ª—è (generic –¥–ª—è `List<T>`), —á–∏—Ç–∞—î –∑–Ω–∞—á–µ–Ω–Ω—è —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ.
* –ö–æ–Ω–≤–µ—Ä—Ç—É—î –ø—Ä–∏–º—ñ—Ç–∏–≤–∏: `BigDecimal -> int/long/double/‚Ä¶`, —Ä—è–¥–∫–∏ ‚Üí `enum`/`String`.
* –ù–µ–≤—ñ–¥–æ–º—ñ –ø–æ–ª—è: **—ñ–≥–Ω–æ—Ä—É—î–º–æ** –∞–±–æ –æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ –∫–∏–¥–∞—î–º–æ –ø–æ–º–∏–ª–∫—É (—Ä–µ–∂–∏–º).

---

## 9) –ü—Ä–∏–∫–ª–∞–¥

–í—Ö—ñ–¥:

```json
{"id": 1, "tags": ["a","b"], "ok": true}
```

–¢–æ–∫–µ–Ω–∏:

```
START_OBJECT
FIELD_NAME("id") COLON NUMBER_VALUE(1) COMMA
FIELD_NAME("tags") COLON START_ARRAY STRING_VALUE("a") COMMA STRING_VALUE("b") END_ARRAY COMMA
FIELD_NAME("ok") COLON TRUE_VALUE
END_OBJECT
EOF
```

---

# üîß –ü—ñ–¥—Ö—ñ–¥

–Ñ –¥–≤–∞ –Ω–æ—Ä–º–∞–ª—å–Ω—ñ –≤–∞—Ä—ñ–∞–Ω—Ç–∏:

**A) 2-—Ñ–∞–∑–Ω–∏–π:**

1. —Ç–æ–∫–µ–Ω–∏ ‚Üí –ø—Ä–æ–º—ñ–∂–Ω–∞ –º–æ–¥–µ–ª—å (AST): `Map<String,Object>` / `List<Object>` / –ø—Ä–∏–º—ñ—Ç–∏–≤–∏;
2. AST ‚Üí POJO —á–µ—Ä–µ–∑ —Ä–µ—Ñ–ª–µ–∫—Å—ñ—é (—Ç–∏–ø–∏/–ø–æ–ª—è/generic-–∏).

* –ü—Ä–æ—Å—Ç–∏–π –¥–ª—è –≤—ñ–¥–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è, –∞–ª–µ –±—ñ–ª—å—à–µ –ø–∞–º‚Äô—è—Ç—ñ.

**B) –°—Ç—Ä—ñ–º—ñ–Ω–≥–æ–≤–∏–π (—Ä–µ–∫–æ–º–µ–Ω–¥—É—é):**

1. —á–∏—Ç–∞—î–º–æ —Ç–æ–∫–µ–Ω–∏ —Ç–∞ **–æ–¥—Ä–∞–∑—É** —Å–µ—Ç–∏–º–æ –ø–æ–ª—è –æ–±‚Äô—î–∫—Ç–∞;
2. –¥–ª—è –≤–∫–ª–∞–¥–µ–Ω–∏—Ö –æ–±‚Äô—î–∫—Ç—ñ–≤/–º–∞—Å–∏–≤—ñ–≤ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ –≤–∏–∫–ª–∏–∫–∞—î–º–æ binder.

* –ú–µ–Ω—à–µ –∑–∞–π–≤–∏—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä, —à–≤–∏–¥—à–µ.

–ù–∏–∂—á–µ ‚Äî –≤–∞—Ä—ñ–∞–Ω—Ç B (—Å—Ç—Ä—ñ–º—ñ–Ω–≥–æ–≤–∏–π).

---

# üîÅ –ê–ª–≥–æ—Ä–∏—Ç–º (—Å—Ç—Ä—ñ–º—ñ–Ω–≥–æ–≤–∏–π)

1. `readObject(Class<T>)`:

    * –æ—á—ñ–∫—É—î `START_OBJECT`;
    * —Å—Ç–≤–æ—Ä—é—î `T instance`;
    * –ø–æ–∫–∏ –Ω–µ `END_OBJECT`: –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ `FIELD_NAME` ‚Üí –∑–Ω–∞–π—Ç–∏ `Field` –∑–∞ —ñ–º‚Äô—è–º ‚Üí `readValue(fieldType)` ‚Üí `field.set(instance, value)`;
    * –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ —ñ–Ω—Å—Ç–∞–Ω—Å.

2. `readValue(Class<?> type)`:

    * —è–∫—â–æ —Ç–æ–∫–µ–Ω `START_OBJECT` ‚Üí `readObject(type)` (–¥–ª—è POJO –∞–±–æ Map).
    * —è–∫—â–æ `START_ARRAY` ‚Üí `readArray(elemType)` —ñ –∑–∞–≤–µ—Ä–Ω—É—Ç–∏ —É: –º–∞—Å–∏–≤/`List`/`Set` (–≤ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—ñ–¥ `type`).
    * —è–∫—â–æ –ø—Ä–∏–º—ñ—Ç–∏–≤–Ω–∏–π —Ç–æ–∫–µ–Ω (`VALUE_STRING/NUMBER/TRUE/FALSE/NULL`) ‚Üí `convertPrimitive(type, token)`.

3. `readArray(elemType)`:

    * –æ—á—ñ–∫—É—î `START_ARRAY`;
    * –ø–æ–∫–∏ –Ω–µ `END_ARRAY`: `readValue(elemType)` —ñ –¥–æ–¥–∞—Ç–∏ –≤ —Å–ø–∏—Å–æ–∫;
    * –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ `List<?>`.

4. `convertPrimitive(type, token)`:

    * `String`, `int/Integer`, `long/Long`, `double/Double`, `BigDecimal`, `boolean/Boolean`, `enum`, `UUID`, `LocalDate` (—è–∫—â–æ —Ç—Ä–µ–±–∞).
    * `NULL` ‚Üí `null` (–¥–ª—è –ø—Ä–∏–º—ñ—Ç–∏–≤—ñ–≤ ‚Äî –∫–∏–Ω—É—Ç–∏ –ø–æ–º–∏–ª–∫—É –∞–±–æ –¥–µ—Ñ–æ–ª—Ç).

5. –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è generic-—ñ–≤:

    * –¥–ª—è `List<User>` –¥—ñ—Å—Ç–∞–Ω—å `User` —ñ–∑ `Field.getGenericType()` (—è–∫ `ParameterizedType`).

---

# üí° –ü–æ—Ä–∞–¥–∏

* –ö–µ—à—É–π `buildFieldIndex(Class<?>)` —É `ConcurrentHashMap<Class<?>, Map<String,Field>>`.
* –î–æ–¥–∞–π –ø—ñ–¥—Ç—Ä–∏–º–∫—É `@JsonName("...")`, —â–æ–± –º–∞–ø–∏—Ç–∏ —ñ–Ω—à—ñ —ñ–º–µ–Ω–∞.
* –û–±—Ä–æ–±–∏ **–Ω–µ–≤—ñ–¥–æ–º—ñ –ø–æ–ª—è**: –∞–±–æ —ñ–≥–Ω–æ—Ä—É–π, –∞–±–æ –∫–∏–¥–∞–π –ø–æ–º–∏–ª–∫—É ‚Äî –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ä–µ–∂–∏–º—É.
* –î–ª—è `List<T>` –¥–µ—Ç–µ–∫—Ç –±—É–¥—å –ª–∞—Å–∫–∞ —Ç–∏–ø –µ–ª–µ–º–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ `ParameterizedType`.
* –î–ª—è `Map<String,V>` (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ) ‚Äî –æ–∫—Ä–µ–º–∞ –≥—ñ–ª–∫–∞, –¥–µ `FIELD_NAME` ‚Üí `readValue(V)`.

